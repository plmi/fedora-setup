---
- name: Install pentest core packages
  ansible.builtin.dnf:
    name: "{{ pentest_core_packages }}"
    state: present

- name: Ensure dependencies for GitHub-installed tools are present
  ansible.builtin.dnf:
    name:
      - perl
      - perl-JSON
      - perl-XML-Writer
      - unzip
      - pipx
      - ruby
      - ruby-devel
      - rubygems-devel
      - java-21-openjdk
    state: present

- name: Require aarch64 for GitHub feroxbuster binary install
  ansible.builtin.assert:
    that:
      - ansible_facts["architecture"] == "aarch64"
    fail_msg: "This feroxbuster install path is configured only for aarch64 Linux hosts."

- name: Fetch latest feroxbuster release metadata
  ansible.builtin.uri:
    url: https://api.github.com/repos/epi052/feroxbuster/releases/latest
    method: GET
    return_content: true
  register: feroxbuster_latest_release

- name: Set feroxbuster release facts
  ansible.builtin.set_fact:
    feroxbuster_release_version: "{{ feroxbuster_latest_release.json.tag_name | regex_replace('^v', '') }}"
    feroxbuster_asset_url: >-
      {{
        feroxbuster_latest_release.json.assets
        | selectattr('name', 'equalto', feroxbuster_asset_name)
        | map(attribute='browser_download_url')
        | list
        | first
      }}
    feroxbuster_archive_path: "/tmp/{{ feroxbuster_asset_name }}"
    feroxbuster_extract_dir: "/tmp/feroxbuster-release"

- name: Ensure feroxbuster asset exists in latest release
  ansible.builtin.assert:
    that:
      - feroxbuster_asset_url is defined
      - feroxbuster_asset_url | length > 0
    fail_msg: "Could not find {{ feroxbuster_asset_name }} in latest feroxbuster release."

- name: Check currently installed feroxbuster version
  ansible.builtin.command: "feroxbuster --version"
  register: feroxbuster_installed_version_cmd
  changed_when: false
  failed_when: false

- name: Parse installed feroxbuster version
  ansible.builtin.set_fact:
    feroxbuster_installed_version: "{{ feroxbuster_installed_version_cmd.stdout | regex_search('[0-9]+\\.[0-9]+\\.[0-9]+') | default('') }}"

- name: Prepare temporary feroxbuster extraction directory
  ansible.builtin.file:
    path: "{{ feroxbuster_extract_dir }}"
    state: directory
    mode: "0755"
  when: feroxbuster_installed_version != feroxbuster_release_version

- name: Download latest feroxbuster archive
  ansible.builtin.get_url:
    url: "{{ feroxbuster_asset_url }}"
    dest: "{{ feroxbuster_archive_path }}"
    mode: "0644"
  when: feroxbuster_installed_version != feroxbuster_release_version

- name: Extract feroxbuster archive
  ansible.builtin.unarchive:
    src: "{{ feroxbuster_archive_path }}"
    dest: "{{ feroxbuster_extract_dir }}"
    remote_src: true
  when: feroxbuster_installed_version != feroxbuster_release_version

- name: Find extracted feroxbuster binary
  ansible.builtin.find:
    paths: "{{ feroxbuster_extract_dir }}"
    file_type: file
    recurse: true
    patterns: "^feroxbuster$"
    use_regex: true
  register: feroxbuster_binary_candidates
  when: feroxbuster_installed_version != feroxbuster_release_version

- name: Ensure extracted feroxbuster binary is found
  ansible.builtin.assert:
    that:
      - feroxbuster_binary_candidates.matched | int > 0
    fail_msg: "feroxbuster binary not found in extracted archive."
  when: feroxbuster_installed_version != feroxbuster_release_version

- name: Install feroxbuster binary to /usr/local/bin
  ansible.builtin.copy:
    src: "{{ feroxbuster_binary_candidates.files[0].path }}"
    dest: /usr/local/bin/feroxbuster
    owner: root
    group: root
    mode: "0755"
    remote_src: true
  when: feroxbuster_installed_version != feroxbuster_release_version

- name: Fetch latest nikto release metadata
  ansible.builtin.uri:
    url: https://api.github.com/repos/sullo/nikto/releases/latest
    method: GET
    return_content: true
  register: nikto_latest_release

- name: Set nikto release facts
  ansible.builtin.set_fact:
    nikto_release_tag: "{{ nikto_latest_release.json.tag_name }}"
    nikto_asset_url: >-
      {{
        nikto_latest_release.json.assets
        | selectattr('name', 'equalto', nikto_asset_name)
        | map(attribute='browser_download_url')
        | list
        | first
      }}
    nikto_install_root: /opt/nikto
    nikto_release_dir: "/opt/nikto/{{ nikto_latest_release.json.tag_name }}"
    nikto_current_link: /opt/nikto/current
    nikto_archive_path: "/tmp/{{ nikto_asset_name }}"
    nikto_extract_dir: /tmp/nikto-release

- name: Ensure nikto asset exists in latest release
  ansible.builtin.assert:
    that:
      - nikto_asset_url is defined
      - nikto_asset_url | length > 0
    fail_msg: "Could not find {{ nikto_asset_name }} in latest nikto release."

- name: Check if current nikto release is already installed
  ansible.builtin.stat:
    path: "{{ nikto_release_dir }}/program/nikto.pl"
  register: nikto_release_installed

- name: Ensure nikto install root exists
  ansible.builtin.file:
    path: "{{ nikto_install_root }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Prepare temporary nikto extraction directory
  ansible.builtin.file:
    path: "{{ nikto_extract_dir }}"
    state: directory
    mode: "0755"
  when: not nikto_release_installed.stat.exists

- name: Download latest nikto archive
  ansible.builtin.get_url:
    url: "{{ nikto_asset_url }}"
    dest: "{{ nikto_archive_path }}"
    mode: "0644"
  when: not nikto_release_installed.stat.exists

- name: Extract nikto archive
  ansible.builtin.unarchive:
    src: "{{ nikto_archive_path }}"
    dest: "{{ nikto_extract_dir }}"
    remote_src: true
  when: not nikto_release_installed.stat.exists

- name: Find extracted nikto.pl
  ansible.builtin.find:
    paths: "{{ nikto_extract_dir }}"
    file_type: file
    recurse: true
    patterns: "^nikto\\.pl$"
    use_regex: true
  register: nikto_pl_candidates
  when: not nikto_release_installed.stat.exists

- name: Ensure extracted nikto.pl is found
  ansible.builtin.assert:
    that:
      - nikto_pl_candidates.matched | int > 0
    fail_msg: "nikto.pl not found in extracted nikto archive."
  when: not nikto_release_installed.stat.exists

- name: Set extracted nikto source root
  ansible.builtin.set_fact:
    nikto_source_root: "{{ nikto_pl_candidates.files[0].path | regex_replace('/program/nikto\\.pl$', '') }}"
  when: not nikto_release_installed.stat.exists

- name: Ensure nikto release directory exists
  ansible.builtin.file:
    path: "{{ nikto_release_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  when: not nikto_release_installed.stat.exists

- name: Copy nikto release files into versioned install directory
  ansible.builtin.command:
    cmd: "cp -a {{ nikto_source_root }}/. {{ nikto_release_dir }}/"
  when: not nikto_release_installed.stat.exists

- name: Update nikto current symlink
  ansible.builtin.file:
    src: "{{ nikto_release_dir }}"
    dest: "{{ nikto_current_link }}"
    state: link
    force: true

- name: Install nikto wrapper in /usr/local/bin
  ansible.builtin.copy:
    dest: /usr/local/bin/nikto
    owner: root
    group: root
    mode: "0755"
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      exec /usr/bin/perl /opt/nikto/current/program/nikto.pl "$@"

- name: Ensure sqlmap install root exists
  ansible.builtin.file:
    path: /opt/sqlmap
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Install/update sqlmap from git
  ansible.builtin.git:
    repo: "{{ sqlmap_repo_url }}"
    dest: /opt/sqlmap/current
    version: "{{ sqlmap_repo_ref }}"
    depth: 1
    update: true

- name: Install sqlmap wrapper in /usr/local/bin
  ansible.builtin.copy:
    dest: /usr/local/bin/sqlmap
    owner: root
    group: root
    mode: "0755"
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      exec /usr/bin/python3 /opt/sqlmap/current/sqlmap.py "$@"

- name: Ensure pipx user bin dir exists
  ansible.builtin.file:
    path: "/home/{{ primary_user }}/.local/bin"
    state: directory
    owner: "{{ primary_user }}"
    group: "{{ primary_user }}"
    mode: "0755"

- name: Check whether impacket is installed via pipx
  ansible.builtin.command: "python3 -m pipx list --short"
  become: true
  become_user: "{{ primary_user }}"
  register: pipx_list_output
  changed_when: false

- name: Install impacket via pipx
  ansible.builtin.command: "python3 -m pipx install impacket"
  become: true
  become_user: "{{ primary_user }}"
  when: "'impacket' not in pipx_list_output.stdout"

- name: Check whether Metasploit is installed
  ansible.builtin.command: "snap list {{ metasploit_snap_package }}"
  register: metasploit_check
  changed_when: false
  failed_when: false
  when: metasploit_enable | bool

- name: Ensure snapd is installed
  ansible.builtin.dnf:
    name: snapd
    state: present
  when:
    - metasploit_enable | bool

- name: Ensure snapd socket is enabled
  ansible.builtin.systemd:
    name: snapd.socket
    enabled: true
    state: started
  when:
    - metasploit_enable | bool

- name: Ensure snapd service is started
  ansible.builtin.systemd:
    name: snapd
    state: started
  when:
    - metasploit_enable | bool

- name: Ensure /snap symlink exists
  ansible.builtin.file:
    src: /var/lib/snapd/snap
    dest: /snap
    state: link
    force: true
  when:
    - metasploit_enable | bool

- name: Wait for snap seeding to complete
  ansible.builtin.command: "snap wait system seed.loaded"
  register: snap_seed_wait
  changed_when: false
  retries: 15
  delay: 4
  until: snap_seed_wait.rc == 0
  when:
    - metasploit_enable | bool

- name: Install Metasploit via snap
  ansible.builtin.command: "snap install {{ metasploit_snap_package }}"
  register: metasploit_snap_install
  retries: 5
  delay: 6
  until: metasploit_snap_install.rc == 0
  when:
    - metasploit_enable | bool
    - metasploit_check.rc != 0

- name: Ensure msfconsole symlink is available in /usr/local/bin
  ansible.builtin.file:
    src: "/snap/bin/msfconsole"
    dest: /usr/local/bin/msfconsole
    state: link
    force: true
  when: metasploit_enable | bool

- name: Ensure Burp install directory exists
  ansible.builtin.file:
    path: "{{ burp_install_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Download Burp Community jar
  ansible.builtin.get_url:
    url: "{{ burp_download_url }}"
    dest: "{{ burp_jar_path }}"
    mode: "0644"

- name: Install burp wrapper in /usr/local/bin
  ansible.builtin.copy:
    dest: /usr/local/bin/burp
    owner: root
    group: root
    mode: "0755"
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      export _JAVA_AWT_WM_NONREPARENTING=1
      if [ -x /usr/lib/jvm/java-21-openjdk/bin/java ]; then
        exec /usr/lib/jvm/java-21-openjdk/bin/java -jar "{{ burp_jar_path }}" "$@"
      fi
      exec /usr/bin/java -jar "{{ burp_jar_path }}" "$@"

- name: Install Burp desktop entry for app launchers
  ansible.builtin.copy:
    dest: /usr/share/applications/burp.desktop
    owner: root
    group: root
    mode: "0644"
    content: |
      [Desktop Entry]
      Type=Application
      Name=Burp Suite Community
      GenericName=Web Security Testing
      Comment=Run Burp Suite Community Edition
      Exec=burp
      Terminal=false
      Categories=Security;Network;
      StartupNotify=true

- name: Check whether wpscan is installed via gem
  ansible.builtin.command: "gem list -i wpscan"
  register: wpscan_check
  changed_when: false
  failed_when: false

- name: Install wpscan via gem
  ansible.builtin.command: "gem install wpscan --no-document"
  when: wpscan_check.rc != 0

- name: Ensure SearchSploit install directory parent exists
  ansible.builtin.file:
    path: "{{ searchsploit_install_dir | dirname }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Install/update SearchSploit database
  ansible.builtin.git:
    repo: "{{ searchsploit_repo_url }}"
    dest: "{{ searchsploit_install_dir }}"
    update: true

- name: Link searchsploit into /usr/local/bin
  ansible.builtin.file:
    src: "{{ searchsploit_install_dir }}/searchsploit"
    dest: /usr/local/bin/searchsploit
    state: link
    force: true

- name: Copy SearchSploit rc for managed user
  ansible.builtin.copy:
    src: "{{ searchsploit_install_dir }}/.searchsploit_rc"
    dest: "/home/{{ primary_user }}/.searchsploit_rc"
    owner: "{{ primary_user }}"
    group: "{{ primary_user }}"
    mode: "0644"
    remote_src: true

- name: Adapt SearchSploit rc paths to repo install directory
  ansible.builtin.replace:
    path: "/home/{{ primary_user }}/.searchsploit_rc"
    regexp: "path_array\\+=\\(.*\\)"
    replace: "path_array+=(\"{{ searchsploit_install_dir }}\")"

- name: Ensure Kali-like wordlist directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop:
    - /usr/share/wordlists
    - /usr/share/seclists

- name: Check whether SecLists is already installed
  ansible.builtin.stat:
    path: /usr/share/seclists/README.md
  register: seclists_installed

- name: Download SecLists archive
  ansible.builtin.get_url:
    url: "{{ seclists_zip_url }}"
    dest: /tmp/SecList.zip
    mode: "0644"
  when: not seclists_installed.stat.exists

- name: Remove existing SecLists directory before archive install
  ansible.builtin.file:
    path: /usr/share/seclists
    state: absent
  when: not seclists_installed.stat.exists

- name: Extract SecLists archive parent
  ansible.builtin.unarchive:
    src: /tmp/SecList.zip
    dest: /usr/share
    remote_src: true
  when: not seclists_installed.stat.exists

- name: Move extracted SecLists to Kali-like path
  ansible.builtin.command:
    cmd: mv /usr/share/SecLists-master /usr/share/seclists
  when: not seclists_installed.stat.exists

- name: Remove SecLists archive
  ansible.builtin.file:
    path: /tmp/SecList.zip
    state: absent
  when: not seclists_installed.stat.exists

- name: Check whether rockyou.txt exists in SecLists
  ansible.builtin.stat:
    path: /usr/share/seclists/Passwords/Leaked-Databases/rockyou.txt
  register: seclists_rockyou_txt

- name: Check whether rockyou.txt is already installed at Kali-like path
  ansible.builtin.stat:
    path: /usr/share/wordlists/rockyou.txt
  register: rockyou_installed

- name: Install rockyou.txt from SecLists
  ansible.builtin.copy:
    src: /usr/share/seclists/Passwords/Leaked-Databases/rockyou.txt
    dest: /usr/share/wordlists/rockyou.txt
    owner: root
    group: root
    mode: "0644"
    remote_src: true
  when:
    - not rockyou_installed.stat.exists
    - seclists_rockyou_txt.stat.exists

- name: Download rockyou.txt fallback
  ansible.builtin.get_url:
    url: "{{ rockyou_download_url }}"
    dest: /usr/share/wordlists/rockyou.txt
    mode: "0644"
  when:
    - not rockyou_installed.stat.exists
    - not seclists_rockyou_txt.stat.exists

- name: Install optional pentest packages
  ansible.builtin.dnf:
    name: "{{ pentest_optional_packages }}"
    state: present
  when: pentest_optional_packages | length > 0
